<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cannes Ticket Swap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        .screening-card {
            background-color: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100px;
        }

        .screening-details {
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }

        .screening-title {
            font-size: 16px;
            font-weight: 600;
            color: #222;
            margin-bottom: 4px;
        }

        .full-button {
            background-color: #e53e3e;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 12px;
            margin-top: 8px;
            align-self: flex-start;
        }

        .full-button:hover {
            background-color: #c53030;
        }

        .date-button.active {
            background-color: #4a5568;
            color: white;
        }

        #screening-selection-containers {
            display: flex;
            flex-direction: column;
        }

        .selected-button {
            background-color: #48bb78;
            color: white;
            pointer-events: none;
        }
        .selected-button:hover {
             background-color: #48bb78;
        }

        .date-with-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 10px;
        }

        .day-of-week {
            font-size: 12px;
            color: #777;
            margin-bottom: 2px;
        }

        .date-numeric {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        #confirm-selection-button {
            margin-top: 20px;
        }

        .header-container {
            background: linear-gradient(to right, #F59E0B, #A7F3D0); /* Apply gradient to the container */
            padding: 1rem 0; /* Add padding to the container */
            margin-bottom: 2rem;
            text-align: center; /* Center the heading */
        }

        .header-text {
            color: white; /* Set the text color to white */
            font-weight: 700;  /* Make the text bold */
            font-size: 2.5rem; /* Adjust size as needed */
            display: inline-block; /* Ensure the text is treated as a block */
        }
       .full-text {
            color: #e53e3e;
            font-weight: bold;
            font-size: 12px;
            margin-top: 8px;
            align-self: flex-start;
        }

    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <div class="header-container">
            <h1 class="header-text">3 Days in Cannes Period 1 Ticket Swaps</h1>
        </div>

        <div id="main-content">
            <div id="date-selection-section" class="mb-6">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Select Date</h2>
                <div id="date-picker" class="flex justify-center space-x-2">
                    </div>
            </div>

            <div id="ticket-selection-page" class="space-y-4">
                <h2 class="text-2xl font-semibold text-gray-700">Select Your Ticket</h2>
                <div id="my-tickets-dropdown" class="form-group">
                    <label for="my-tickets" class="form-label">Your Tickets:</label>
                    <select id="my-tickets" class="form-input" required>
                        <option value="" disabled selected>Select a ticket you have</option>
                    </select>
                    <div id="my-tickets-error" class="error-message" style="display: none;"></div>
                </div>
                <div id="screening-selection-containers">
                    </div>
                <button id="confirm-selection-button" class="btn">Confirm Selection</button>
            </div>

            <div id="confirmation-page" class="space-y-4 hidden">
                <h2 class="text-2xl font-semibold text-gray-700">Confirm Swap</h2>
                <p>You are offering your ticket for: <span id="offered-ticket-name" class="font-semibold"></span></p>
                <p>In exchange for a ticket to: <span id="requested-ticket-name" class="font-semibold"></span></p>
                <button id="go-back-button" class="btn bg-gray-400 hover:bg-gray-500 mr-2">Go Back</button>
                <button id="confirm-swap-button" class="btn">Confirm Swap</button>
            </div>

            <div id="email-input-page" class="space-y-4 hidden">
                <h2 class="text-2xl font-semibold text-gray-700">Enter Your Email</h2>
                <p>Please provide your email address. If there's a match, you'll receive an email with the other ticket holder's contact information.</p>
                <div class="form-group">
                    <label for="email-input" class="form-label">Email:</label>
                    <input type="email" id="email-input" class="form-input" required placeholder="your.email@example.com">
                    <div id="email-input-error" class="error-message" style="display: none;"></div>
                </div>
                <button id="submit-email-button" class="btn">Submit</button>
            </div>

            <div id="success-message" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mt-4 hidden" role="alert">
                <strong class="font-bold">Success!</strong>
                <span class="block sm:inline">You've successfully submitted your request for a ticket swap.</span>
            </div>
        </div>
    </div>

    <script>
       // Sample data (replace with actual data from server)
        const userTickets = [
            { id: 1, name: "Parasite", screeningDate: "2024-05-14", screeningTime: "18:00" },
            { id: 2, name: "The French Dispatch", screeningDate: "2024-05-15", screeningTime: "21:00" },
            { id: 3, name: "Dune", screeningDate: "2024-05-16", screeningTime: "15:00" },
        ];

        const screenings = [
            { id: 101, name: "Parasite", screeningDate: "2024-05-14", screeningTime: "18:00", venue: "Grand Theater", isFull: true },
            { id: 102, name: "Parasite", screeningDate: "2024-05-15", screeningTime: "20:00", venue: "Lumière", isFull: false },
            { id: 201, name: "The French Dispatch", screeningDate: "2024-05-15", screeningTime: "21:00", venue: "Debussy", isFull: true },
            { id: 202, name: "The French Dispatch", screeningDate: "2024-05-16", screeningTime: "19:00", venue: "Grand Theater", isFull: false },
            { id: 301, name: "Dune", screeningDate: "2024-05-16", screeningTime: "15:00", venue: "Lumière", isFull: false },
            { id: 302, name: "Dune", screeningDate: "2024-05-18", screeningTime: "22:00", venue: "Debussy", isFull: true },
        ];
        const validDates = ["2024-05-14", "2024-05-15", "2024-05-16"];


        // Get DOM elements for all pages
        const ticketSelectionPage = document.getElementById("ticket-selection-page");
        const confirmationPage = document.getElementById("confirmation-page");
        const emailInputPage = document.getElementById("email-input-page");
        const successMessage = document.getElementById("success-message");
        const datePicker = document.getElementById("date-picker");
        const screeningSelectionContainers = document.getElementById("screening-selection-containers");


        const myTicketsDropdown = document.getElementById("my-tickets");
        const confirmSelectionButton = document.getElementById("confirm-selection-button");
        const goBackButton = document.getElementById("go-back-button");
        const confirmSwapButton = document.getElementById("confirm-swap-button");
        const emailInput = document.getElementById("email-input");
        const submitEmailButton = document.getElementById("submit-email-button");
        const emailInputError = document.getElementById("email-input-error");

        let selectedOfferedTicketId = null;
        let selectedRequestedTicketId = null;
        let userEmail = "";
        let selectedDate = null;

        // Function to show a specific page
        function showPage(pageId) {
            ticketSelectionPage.classList.add("hidden");
            confirmationPage.classList.add("hidden");
            emailInputPage.classList.add("hidden");
            successMessage.classList.add("hidden");
            document.getElementById(pageId).classList.remove("hidden");
        }

        // Function to populate date picker
        function populateDatePicker() {
            //const uniqueDates = [...new Set(screenings.map(screening => screening.screeningDate))];
            const dateMap = {
                "2024-05-14": { display: "May 14", day: "WED" },
                "2024-05-15": { display: "May 15", day: "THU" },
                "2024-05-16": { display: "May 16", day: "FRI" }
            };

            validDates.forEach(date => {
                const dateButton = document.createElement("button");
                dateButton.textContent = dateMap[date].display;
                dateButton.classList.add("btn", "btn-secondary", "date-button");
                dateButton.setAttribute('data-date', date);
                dateButton.addEventListener("click", () => {
                    selectedDate = date;
                    document.querySelectorAll('.date-button').forEach(button => button.classList.remove('active'));
                    dateButton.classList.add('active');
                    populateDropdowns(date);
                });
                datePicker.appendChild(dateButton);
            });
        }

        // Function to populate dropdowns
        function populateDropdowns(date) {
            screeningSelectionContainers.innerHTML = '';
            const filteredScreenings = date ? screenings.filter(screening => screening.screeningDate === date) : screenings;

            if (filteredScreenings.length === 0) {
                screeningSelectionContainers.innerHTML = '<p class="text-gray-500">No screenings available for this date.</p>';
                return;
            }

            const dateMap = {
                "2024-05-14": { display: "May 14", day: "WED" },
                "2024-05-15": { display: "May 15", day: "THU" },
                "2024-05-16": { display: "May 16", day: "FRI" }
            };

            filteredScreenings.forEach(screening => {
                const screeningCard = document.createElement("div");
                screeningCard.className = "screening-card";

                const dateContainer = document.createElement("div");
                dateContainer.className = "date-with-day";
                const dayOfWeek = document.createElement("div");
                dayOfWeek.className = "day-of-week";
                dayOfWeek.textContent = dateMap[screening.screeningDate].day;
                const dateNumeric = document.createElement("div");
                dateNumeric.className = "date-numeric";
                dateNumeric.textContent = dateMap[screening.screeningDate].display;
                dateContainer.appendChild(dayOfWeek);
                dateContainer.appendChild(dateNumeric);


                const title = document.createElement("div");
                title.className = "screening-title";
                title.textContent = screening.name;

                const details = document.createElement("div");
                details.className = "screening-details";
                details.textContent = `${screening.screeningTime} - ${screening.venue}`;

                screeningCard.appendChild(dateContainer);
                screeningCard.appendChild(title);
                screeningCard.appendChild(details);

                const button = document.createElement("button");
                button.className =  "full-button";
                button.textContent =  "I HAVE A TICKET";
                button.disabled = screening.isFull;
                button.setAttribute('data-screening-id', screening.id);
                button.addEventListener('click', handleScreeningSelect);
                screeningCard.appendChild(button);

                screeningSelectionContainers.appendChild(screeningCard);
            });
        }

        function handleScreeningSelect(event) {
            const button = event.target;
             if (button.textContent === "I HAVE A TICKET") {
                button.textContent = "SELECTED";
                button.className = "full-button selected-button";
            }
        }

        // Event listener for confirm selection button (Page 1 -> Page 2)
        confirmSelectionButton.addEventListener("click", () => {
            selectedOfferedTicketId = parseInt(myTicketsDropdown.value);
            const selectedButton = document.querySelector('.screening-card button.selected-button');


            if (!selectedOfferedTicketId) {
                myTicketsError.textContent = "Please select a ticket you have.";
                myTicketsError.style.display = "block";
                return;
            } else {
                myTicketsError.style.display = "none";
            }

             if (!selectedButton) {
                screeningListError.textContent = "Please select a screening.";
                screeningListError.style.display = "block";
                return;
            } else {
                screeningListError.style.display = "none";
            }
            selectedRequestedTicketId = parseInt(selectedButton.getAttribute('data-screening-id'));


            if (selectedOfferedTicketId === selectedRequestedTicketId) {
                alert("You cannot select the same ticket for swapping!");
                return;
            }

            const offeredTicket = userTickets.find(ticket => ticket.id === selectedOfferedTicketId);
            const requestedTicket = screenings.find(screening => screening.id === selectedRequestedTicketId);

            offeredTicketNameDisplay.textContent = `${offeredTicket.name} (${offeredTicket.screeningDate} ${offeredTicket.screeningTime})`;
            requestedTicketNameDisplay.textContent = `${requestedTicket.name} (${requestedTicket.screeningDate} ${requestedTicket.screeningTime})`;

            // 1.  Data Collection
            const swapData = {
                offeredTicketId: selectedOfferedTicketId,
                requestedTicketId: selectedRequestedTicketId,
            };

            // 2.  Send data to the server using fetch
            fetch('/api/ticket-swap', {  //  Endpoint
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(swapData), // Convert data to JSON
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json(); // Parse the JSON response
            })
            .then(data => {
                // 3. Handle the server response
                console.log('Server response:', data);
                if (data.success) {
                    showPage("confirmation-page");
                } else {
                    alert('Failed to submit ticket swap. Please try again.');
                }
            })
            .catch(error => {
                // 4. Handle errors
                console.error('Error submitting ticket swap:', error);
                alert('An error occurred while submitting your request. Please check your connection and try again.');
            });

            showPage("confirmation-page");

        });

        // Event listener for go back button (Page 2 -> Page 1)
        goBackButton.addEventListener("click", () => {
            showPage("ticket-selection-page");
        });

        // Event listener for confirm swap button (Page 2 -> Page 3)
        confirmSwapButton.addEventListener("click", () => {
            showPage("email-input-page");
        });

        // Event listener for submit email button (Page 3 -> Success)
        submitEmailButton.addEventListener("click", () => {
            userEmail = emailInput.value.trim();

            if (!userEmail) {
                emailInputError.textContent = "Please enter your email address.";
                emailInputError.style.display = "block";
                return;
            } else if (!validateEmail(userEmail)) {
                emailInputError.textContent = "Please enter a valid email address.";
                emailInputError.style.display = "block";
                return;
            } else {
                emailInputError.style.display = "none";
            }

            // In a real application, you would send this data to your server
            console.log("User Email:", userEmail);
             // Simulate sending data to the server
            setTimeout(() => {
                showPage("success-message");
            }, 1000);
        });

        // Email validation function
        function validateEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        // Initialize
        populateDatePicker();
        populateDropdowns(selectedDate);
        showPage("ticket-selection-page");

    </script>
</body>
</html>
